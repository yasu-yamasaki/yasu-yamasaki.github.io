<!doctype html><html lang=jp><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><title>internalスコープのclassをconstructor injectionする(Kotlin, Spring) ｜ ヤス ブロ</title><meta name=description content="掲題の件について、若干詰まったのでブログに残す。 &amp;hellip; やりたいこと 以下のようなinternal classを @Service internal class SubService { /* .. */ } 以下のようなclas"><link rel="shortcut icon" href=https://yasu-yamasaki.github.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/highlight.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-824YMCP1EF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-824YMCP1EF');</script></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://yasu-yamasaki.github.io/><span>ヤス ブロ</span></a></h1></div><div class=description><p class=sub_title>ハードルは下げる。ネガティブなことは書かない。</p><div class=my_socials><a href=https://www.facebook.com/yasuyuki.yamasaki.79 title=facebook target=_blank><i class=ri-facebook-fill></i></a><a href=github title=github target=_blank><i class=ri-github-fill></i></a><a href=https://twitter.com/yasu_yamasaki title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=https://yasu-yamasaki.github.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/202105/scope/>internalスコープのclassをconstructor injectionする(Kotlin, Spring)</a></h2><span class=date>2021.05.06</span></div><div class="post_content markdown"><p>掲題の件について、若干詰まったのでブログに残す。</p><p>&mldr;</p><h2 id=やりたいこと>やりたいこと</h2><p>以下のようなinternal classを</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubService</span> { <span style=color:#75715e>/* .. */</span> }
</code></pre></div><p>以下のようなclassにconstructor injectionさせたい</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainService</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> subService: SubService) { <span style=color:#75715e>/* .. */</span> }
</code></pre></div><p>SubServiceとMainServiceは同じパッケージとする。</p><h2 id=え普通にできないんだっけ>え？普通にできないんだっけ？</h2><p>上記例はコンパイルエラーになる。<br>なぜなら、publicなclassのprimaryコンストラクタはpublicスコープであり、
そこにintenalスコープのclassのインスタンスを引数に取れないから。</p><h2 id=解決策-constructor-injectionを諦める>解決策① constructor injectionを諦める</h2><p>これが一番簡単。だが、そもそも掲題の前提条件を満たしていないように思う。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainService</span> {
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> subService: SubService

    <span style=color:#75715e>/* .. */</span> 
}
</code></pre></div><h2 id=解決策-mainserviceもinternalスコープにしちゃう>解決策② MainServiceもinternalスコープにしちゃう</h2><p>MainServiceもinternalスコープにしてしまえば、primaryコンストラクタもinternalスコープになるので
コンパイルエラーにならなくなる。<br>ただ、パッケージ外のMainServiceに依存するクラスがMainServiceをみれなくなるので、
MainServiceをpublicなinterfaceにして、実装クラスをinternalスコープにする。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MainService</span> { <span style=color:#75715e>/* .. */</span> }

<span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainServiceImpl</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> subService: SubService): MainService { 
<span style=color:#75715e>/* .. */</span> 
}
</code></pre></div><p>一瞬SpringがちゃんとMainServiceImplをInjectionしてくれるのかなと不安になったけど、問題なく動作した。<br>Spring以外のフレームワークを使っていて、internalスコープのclassを他パッケージにinjectさせたい場合は、
publicなMainServiceFactoryを作れば解決できそう。</p><p>以上</p></div><div class=post_footer><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i><a href=https://yasu-yamasaki.github.io/tags/kotlin/>Kotlin</a>
<a href=https://yasu-yamasaki.github.io/tags/tech/>Tech</a>
<a href=https://yasu-yamasaki.github.io/tags/spring/>Spring</a></span></div></div></div></div><div class=doc_comments></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span></span></div></footer><script src=https://yasu-yamasaki.github.io/js/jquery-3.5.1.min.js></script><link href=https://yasu-yamasaki.github.io/css/fancybox.min.css rel=stylesheet><script src=https://yasu-yamasaki.github.io/js/fancybox.min.js></script><script src=https://yasu-yamasaki.github.io/js/zozo.js></script></body></html>