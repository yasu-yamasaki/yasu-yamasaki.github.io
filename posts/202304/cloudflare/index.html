<!doctype html><html lang=jp><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><title>Cloudflare Zero Trustを使ってクライアントPCのGlobalIPを固定する ｜ ヤス ブロ</title><meta name=description content="背景 開発環境の口を狭くするために、リモート環境のクライアントPCのGlobalIPを固定したかった。 IPの固定だけに、Cloudflare Zero"><link rel="shortcut icon" href=https://yasu-yamasaki.github.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/zozo.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://yasu-yamasaki.github.io/css/highlight.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-824YMCP1EF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-824YMCP1EF');</script></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://yasu-yamasaki.github.io/><span>ヤス ブロ</span></a></h1></div><div class=description><p class=sub_title>ハードルは下げる。ネガティブなことは書かない。</p><div class=my_socials><a href=https://www.facebook.com/yasuyuki.yamasaki.79 title=facebook target=_blank><i class=ri-facebook-fill></i></a><a href=github title=github target=_blank><i class=ri-github-fill></i></a><a href=https://twitter.com/yasu_yamasaki title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=https://yasu-yamasaki.github.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/202304/cloudflare/>Cloudflare Zero Trustを使ってクライアントPCのGlobalIPを固定する</a></h2><span class=date>2023.04.02</span></div><div class="post_content markdown"><h2 id=背景>背景</h2><p>開発環境の口を狭くするために、リモート環境のクライアントPCのGlobalIPを固定したかった。
IPの固定だけに、Cloudflare Zero Trustを使うのはオーバスペック感はあるけど、50名まで無料で使え、ついでに、マルウェアの対策になるらしいので、
使ってみることにした。</p><h2 id=構成>構成</h2><p><img src=cf.png alt=構成></p><p>private subnetにして、NAT GatewayにEIPを割り当てるほうが、セキュリティ的には良いですが、
NAT Gateway分のお金を節約するために、直、エージェント用のサーバからインターネットに出るようにしました。</p><p>将来、この環境を別のVPCとPeeringして、みたいな構成にする時にやればいいと思うので、とりあえずは、これで。</p><h2 id=やることの流れ>やることの流れ</h2><ol><li>Cloudflareのアカウントを作る</li><li>Zero TrustのTeam domainを定義する</li><li>Planで、Free Planを選ぶ（これをしないとtunnelが設定できない）</li><li>Zero Trust -> Settings -> Firewall -> Proxyを有効にする</li><li>Access -> Tunnels -> Create Tunnel
6. Routesは0.0.0.0/0にして、全てのトラフィックをトンネルに流す</li><li>AWSで上記構成を参考に環境を作る</li><li>EC2インスタンスを立てる(ubuntu,T2,microでOK)</li><li>CloudflareのTunnelにあるコマンドをコピーして、EC2インスタンスで実行。トンネルが繋がる
10. 同じことをもう１台やれば、冗長化できる</li><li>クライアントPCにWRAPをインストールする</li><li>WRAPを起動して、設定する。</li></ol><h2 id=感想>感想</h2><h3 id=接続中も回線速度が速い>接続中も回線速度が速い</h3><p>インターネット回線速度テストの結果が、むしろ接続した方が良い結果になる</p><h3 id=接続のon-offがめちゃ楽>接続のON, OFFがめちゃ楽</h3><p>トグルをオンオフするだけ</p><h3 id=安い>安い</h3><p>かかるのはAWSの料金だけ</p><h3 id=設定には慣れが必要>設定には慣れが必要</h3><p>２、３日向き合うと、理解できるけど、できることが多く、最初はよくわからなかった。</p><h2 id=その他tips>その他、TIPS</h2><h3 id=マルウェア対策について>マルウェア対策について</h3><p>マルウェア対策は、Firewall policiesで設定する。色々監視してくれて良いが、HTTPSの通信を監視してもらうには、
設定を有効にした上で、クライアントにCloudflareのCA証明書をインストールしないといけない。
仕方ないけど、ちょっと全利用者にお願いしてっていうのもあれなので、今回はあきらめた。</p><p><img src=img.png alt=img.png></p><h2 id=総評>総評</h2><p>最初、学習コストは高いけど、Cloudflareはとても良いプロダクト。
まずは、IPを固定する用途で入れで、徐々に会社のフェーズに合わせて、セキュリティを強化していく感じの使い方ができそう。</p></div><div class=post_footer><div class=meta><div class=info><span class="field tags"><i class=ri-stack-line></i><a href=https://yasu-yamasaki.github.io/tags/infra/>infra</a>
<a href=https://yasu-yamasaki.github.io/tags/tech/>Tech</a></span></div></div></div></div><div class=doc_comments></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span></span></div></footer><script src=https://yasu-yamasaki.github.io/js/jquery-3.5.1.min.js></script><link href=https://yasu-yamasaki.github.io/css/fancybox.min.css rel=stylesheet><script src=https://yasu-yamasaki.github.io/js/fancybox.min.js></script><script src=https://yasu-yamasaki.github.io/js/zozo.js></script></body></html>